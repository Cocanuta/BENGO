<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BENGO 2018</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/fontawesome-all.min.css">
</head>
<body>

<nav class="navbar navbar-dark bg-dark sticky-top" style="box-shadow: 0px 0px 8px #000000;">
    <span class="navbar-brand mb-0 h1">BENGO 2018</span>
    <span class="navbar-text" id="conferenceTitle"></span>
</nav>

<div class="container text-center">
    <div id="game" style="display: none; padding: 2px;">
        <div id="gameBoard"></div>
    </div>
    <div id="setName" style="display: none;">
        <form class="form-signin">
            <h1 class="h3 mb-3 font-weight-normal">Choose Name</h1>
            <label for="setNameInput" class="sr-only">Name</label>
            <input type="text" id="setNameInput" class="form-control" placeholder="Name" required="" autofocus="true" style="background-image: url(&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAASCAYAAABSO15qAAAAAXNSR0IArs4c6QAAAPhJREFUOBHlU70KgzAQPlMhEvoQTg6OPoOjT+JWOnRqkUKHgqWP4OQbOPokTk6OTkVULNSLVc62oJmbIdzd95NcuGjX2/3YVI/Ts+t0WLE2ut5xsQ0O+90F6UxFjAI8qNcEGONia08e6MNONYwCS7EQAizLmtGUDEzTBNd1fxsYhjEBnHPQNG3KKTYV34F8ec/zwHEciOMYyrIE3/ehKAqIoggo9inGXKmFXwbyBkmSQJqmUNe15IRhCG3byphitm1/eUzDM4qR0TTNjEixGdAnSi3keS5vSk2UDKqqgizLqB4YzvassiKhGtZ/jDMtLOnHz7TE+yf8BaDZXA509yeBAAAAAElFTkSuQmCC&quot;); background-repeat: no-repeat; background-attachment: scroll; background-size: 16px 18px; background-position: 98% 50%;">
            <button class="btn btn-lg btn-success btn-block" id="setNameSubmit">Sign in</button>
            <p class="mt-5 mb-3 text-muted">© SnatchyBuckles 2018</p>
        </form>
    </div>
    <div id="changeName" style="display: none; min-height: 80%;">
        <form class="form-signin" style=" overflow: auto;">
            <h1 class="h3 mb-3 font-weight-normal">Change Name</h1>
            <label for="setNameInput" class="sr-only">Name</label>
            <input type="text" id="changeNameInput" class="form-control" placeholder="Name" required="" autofocus="true" style="background-image: url(&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAASCAYAAABSO15qAAAAAXNSR0IArs4c6QAAAPhJREFUOBHlU70KgzAQPlMhEvoQTg6OPoOjT+JWOnRqkUKHgqWP4OQbOPokTk6OTkVULNSLVc62oJmbIdzd95NcuGjX2/3YVI/Ts+t0WLE2ut5xsQ0O+90F6UxFjAI8qNcEGONia08e6MNONYwCS7EQAizLmtGUDEzTBNd1fxsYhjEBnHPQNG3KKTYV34F8ec/zwHEciOMYyrIE3/ehKAqIoggo9inGXKmFXwbyBkmSQJqmUNe15IRhCG3byphitm1/eUzDM4qR0TTNjEixGdAnSi3keS5vSk2UDKqqgizLqB4YzvassiKhGtZ/jDMtLOnHz7TE+yf8BaDZXA509yeBAAAAAElFTkSuQmCC&quot;); background-repeat: no-repeat; background-attachment: scroll; background-size: 16px 18px; background-position: 98% 50%;">
            <button class="btn btn-lg btn-success btn-block" id="changeNameSubmit">Change</button>
            <button class="btn btn-lg btn-success btn-block" id="changeNameBack">Back</button>
            <p class="mt-5 mb-3 text-muted">© SnatchyBuckles 2018</p>
        </form>
    </div>
    <div id="stats" style="display: none;">
        <ul class="list-group">
            <li class="list-group-item d-flex justify-content-between align-items-center">
                Microsoft
                <span class="badge badge-pill" style="background-color: #107c10" id="countMicrosoft"></span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                Bethesda
                <span class="badge badge-pill" style="background-color: #DE2C25" id="countBethesda"></span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                Square-Enix
                <span class="badge badge-pill" style="background-color: #a61b27" id="countSquareEnix"></span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                Ubisoft
                <span class="badge badge-pill" style="background-color: #4E5C9D" id="countUbisoft"></span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                PC Gaming Show
                <span class="badge badge-pill" style="background-color: #be7800" id="countPCGaming"></span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                Playstation
                <span class="badge badge-pill" style="background-color: #0E51A0" id="countPlaystation"></span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center" style="background-color: #474747;">
                Total
                <span class="badge badge-pill" style="background-color: #28a745" id="countTotal"></span>
            </li>
        </ul>
        <button class="btn btn-lg btn-success btn-block" id="statsBack">Back</button>
    </div>
    <div id="error" style="display: none; min-height: 100%; margin-top: 50%">
        <h1 id="errorTitle" class="h3 mb-3 font-weight-normal"></h1>
        <span id="errorMessage"></span>
        <button class="btn btn-lg btn-success btn-block" id="errorButton" style="margin: 20px auto; max-width: 230px;">Retry</button>
    </div>
    <div class="loader" style="display: none">
    </div>
</div>

<footer class="footer sticky-bottom" style="display: none; box-shadow: 0px 0px 8px #000000;">
    <div class="container">
        <div class="row text-center">
            <div class="col-4"><i id="navStats" class="fas fa-chart-bar fa-2x"></i></div>
            <div class="col-4"><i id="navRefresh" class="fas fa-sync-alt fa-2x"></i></div>
            <div class="col-4"><i id="navSettings" class="fas fa-cog fa-2x"></i></div>
        </div>
    </div>
</footer>

<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="cordova.js"></script>
<script src="js/socket.io.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/jquery.fittext.js"></script>
<script>
    let user = null;
    let board = null;
    const socket = io('http://bengo.snatchybuckles.com');

    (function() {
        onLoad();
    })();

    function onLoad() {
        document.addEventListener("deviceready", onDeviceReady, false);
    }

    function onDeviceReady() {
        showLoader();
        requestUser();

        socket.on('connect_timeout', function() {
            $('#game').hide();
            $('#changeName').hide();
            $('#setName').hide();
            $('#stats').hide();
            hideFooter();
            $('#errorTitle').text("Unable To Connect");
            $('#errorMessage').text("Lost connection to the server.");
            hideLoader();
            $('#error').show();
        });

        socket.on('connect_error', function() {
            $('#game').hide();
            $('#changeName').hide();
            $('#setName').hide();
            $('#stats').hide();
            hideFooter();
            $('#errorTitle').text("Unable To Connect");
            $('#errorMessage').text("Unable to reach the server.");
            hideLoader();
            $('#error').show();
        });

        socket.on('updateGame', function(data) {
            updateBoard(data.tiles);
            updateConference(data.conference);
            showFooter();
        });

        socket.on('statusChanged', function() {
            $('#game').hide();
            $('#stats').hide();
            $('#changeName').hide();
            $('#error').hide();
            $('#setName').hide();
            showLoader();
            requestUser();
        });

        socket.on('errorMessage', function(data) {
            $('#game').hide();
            $('#changeName').hide();
            $('#setName').hide();
            $('#stats').hide();
            hideFooter();
            hideLoader();
            $('#errorTitle').text(data.title);
            $('#errorMessage').text(data.message);
            $('#error').show();
        });

        socket.on('conferenceUpdate', function(data) {
            updateConference(data.conference);
        });
    }

    $('#setNameSubmit').click(function(event){
        if($('#setNameInput').val() !== "") {
            event.preventDefault();
            window.localStorage.setItem('user', $('#setNameInput').val());
            user = $('#setNameInput').val();
            $('#setName').hide();
            board = null;
            loadGame();
        }
    });

    $('#navSettings').click(function(event) {
        $('#game').hide();
        $('#changeNameInput').val(user);
        hideFooter();
        $('#changeName').show();
    });

    $('#navRefresh').click(function(event) {
        $('#game').hide();
        showLoader();
        loadGame();
    });

    $('#navStats').click(function(event) {
        $('#game').hide();
        hideFooter();
        $('#stats').show();
    })

    $('#changeNameBack').click(function(event) {
        event.preventDefault();
        $('#changeName').hide();
        $('#game').show();
        showFooter();
    });

    $('#statsBack').click(function(event) {
        event.preventDefault();
        $('#stats').hide();
        $('#game').show();
        showFooter();
    });

    $('#errorButton').click(function(event) {
        event.preventDefault();
        $('#error').hide();
        requestUser();
    });

    $('#changeNameSubmit').click(function(event) {
        if($('#changeNameInput').val() !== "") {
            event.preventDefault();
            socket.emit('changeName', { old: user, new: $('#changeNameInput').val()});
            window.localStorage.setItem('user', $('#changeNameInput').val());
            user = $('#changeNameInput').val();
            $('#changeName').hide();
            showLoader();
            board = null;
            loadGame();
        }
    });

    function updateBoard(tiles) {
        if(board === null) {
            $('#game').hide();
            showLoader();
            board = [];
            let boardContainer = $('#gameBoard');
            boardContainer.empty();
            let table = $('<div>');
            let id = 0;
            for(let i = 0; i < 9; i++) {
                let row = $('<div class="row flex-fill">');
                for(let r = id; r < (id + 4); r++) {
                    let color = "#515151";
                    if(tiles[r].checked)
                        color = tiles[r].checkedColor;
                    let tile = $('<div onclick="tickTile(' + r + ')" style="display: flex; align-items: center; color: whitesmoke; margin: 0.5%; padding: 2px; width: 24%; border-radius: 5px; border: 1px solid darkgrey;border-right-color: black;border-bottom-color: black;height: 100px; background-color: ' + color + '; font-weight: bold;" class="bingoTile" data-id="' + tiles[r].tile.id + '"><span style="margin: auto;">' + tiles[r].tile.title + '</span></div>');
                    row.append(tile);
                    setTimeout(function() { tile.height(tile.width()); tile.fitText(0.7); }, 0);
                    board.push({ div: tile, tileContainer: tiles[r] });
                }
                table.append(row);
                id += 4;
            }
            boardContainer.append(table);
            hideLoader();
            $('#game').show();
            showFooter();
        } else {
            for(let i = 0; i < board.length; i++) {
                if(board[i].tileContainer.tile.id !== tiles[i].tile.id
                || board[i].tileContainer.checked !== tiles[i].checked
                || board[i].tileContainer.checkedColor !== tiles[i].checkedColor) {
                    board[i].div.data('id', tiles[i].tile.id);
                    board[i].div.children().first().text(tiles[i].tile.title);
                    let color = "#515151";
                    if(tiles[i].checked)
                        color = tiles[i].checkedColor;
                    board[i].div.css('background-color', color);
                    board[i].tileContainer = tiles[i];
                }
            }
            hideLoader();
            $('#game').show();
            showFooter();
        }

        let microsoft = 0;
        let bethesda = 0;
        let squareEnix = 0;
        let ubisoft = 0;
        let pcGaming = 0;
        let playstation = 0;

        for(let i = 0; i < tiles.length; i++) {
            if(tiles[i].checked) {
                switch(tiles[i].checkedColor) {
                    case "#107c10" :
                        microsoft++;
                        break;
                    case "#DE2C25":
                        bethesda++;
                        break;
                    case "#a61b27":
                        squareEnix++;
                        break;
                    case "#4E5C9D":
                        ubisoft++;
                        break;
                    case "#be7800":
                        pcGaming++;
                        break;
                    case "#0E51A0":
                        playstation++;
                        break;
                }
            }
        }
        $('#countMicrosoft').text(microsoft);
        $('#countBethesda').text(bethesda);
        $('#countSquareEnix').text(squareEnix);
        $('#countUbisoft').text(ubisoft);
        $('#countPCGaming').text(pcGaming);
        $('#countPlaystation').text(playstation);
        $('#countTotal').text(microsoft + bethesda + squareEnix + ubisoft + pcGaming + playstation);
    }

    function loadGame() {
        showLoader();
        socket.emit('requestGame', {user: user});
    }

    function updateConference(conference) {
        $('#conferenceTitle').text(conference.name);
    }

    function requestUser() {
        showLoader();
        if(user === null) {
            let c = window.localStorage.getItem('user');
            if(c === null) {
                hideLoader();
                $('#setName').show();
            } else {
                user = c;
                loadGame();
            }
        } else {
            loadGame();
        }
    }

    function showLoader() {
        $('.loader').show();
    }
    function hideLoader() {
        $('.loader').hide();
    }

    function showFooter() {
        $('.footer').show();
    }

    function hideFooter() {
        $('.footer').hide();
    }

    function tickTile(id) {
        socket.emit('tickTile', {user: user, id: id});
        loadGame();
    }
</script>
</body>
</html>